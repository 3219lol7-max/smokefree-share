<script>
  const params = new URLSearchParams(location.search);
  const imgUrl = params.get('img');
  const img = document.getElementById('img');
  img.src = imgUrl;

  const title = '–ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç SmokeFree';
  const text  = '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –∫–∞–∫ —è –¥–≤–∏–≥–∞—é—Å—å –∫ –∂–∏–∑–Ω–∏ –±–µ–∑ —Å–∏–≥–∞—Ä–µ—Ç! üö≠';

  async function shareImageFile() {
    try {
      // –ü—Ä–æ–≤–µ—Ä–∏–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —à–∞—Ä–∏–Ω–≥–∞ —Ñ–∞–π–ª–æ–≤
      const fileProbe = new File([''], 'probe.png', { type: 'image/png' });
      const canShareFiles = !!(navigator.canShare && navigator.canShare({ files: [fileProbe] }));

      if (canShareFiles) {
        // –°–∫–∞—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∫–∞–∫ Blob (–Ω—É–∂–µ–Ω CORS ‚Äî —É Cloudinary –æ–Ω —Ä–∞–∑—Ä–µ—à—ë–Ω)
        const res = await fetch(imgUrl, { mode: 'cors', cache: 'no-store' });
        if (!res.ok) throw new Error('fetch failed');
        const blob = await res.blob();
        const ext = (blob.type && blob.type.split('/')[1]) || 'png';
        const file = new File([blob], `smokefree.${ext}`, { type: blob.type || 'image/png' });

        await navigator.share({ files: [file], title, text });
        return;
      }

      // –ï—Å–ª–∏ —à–∞—Ä–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º –æ–±—ã—á–Ω—ã–π share c URL
      if (navigator.share) {
        await navigator.share({ title, text, url: location.href });
        return;
      }

      // –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Ñ–æ–ª–±—ç–∫ ‚Äî –æ—Ç–∫—Ä—ã—Ç—å —Å–∞–º—É –∫–∞—Ä—Ç–∏–Ω–∫—É
      window.open(imgUrl, '_blank');
    } catch (e) {
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª —à–∞—Ä–∏–Ω–≥ –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ ‚Äî –æ—Ç–∫—Ä–æ–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É
      window.open(imgUrl, '_blank');
    }
  }

  document.getElementById('share').addEventListener('click', shareImageFile);
</script>
