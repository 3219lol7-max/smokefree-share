<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º ‚Ä¢ SmokeFree</title>
  <style>
    :root { --bg:#0b0c10; --fg:#fff; --glass:rgba(20,20,24,.9); }
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:480px;margin:0 auto;padding:16px}
    .hint{background:#1f2937;border-radius:12px;padding:10px 12px;margin:12px 16px;font-size:14px;line-height:1.35}
    img{width:100%;height:auto;border-radius:16px;display:block;background:#111}
    .bar{position:fixed;left:0;right:0;bottom:0;background:var(--glass);backdrop-filter:blur(6px);padding:12px 16px;display:flex;gap:10px}
    .btn{flex:1;padding:14px 16px;border:0;border-radius:12px;font-size:16px}
    .muted{opacity:.8}
    .hidden{display:none}
  </style>
</head>
<body>
  <div id="tg-hint" class="hint hidden">–ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–Ω—É—Ç—Ä–∏ Telegram, –Ω–∞–∂–º–∏—Ç–µ ¬´‚ãØ¬ª ‚Üí <b>–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ</b> (Safari/Chrome), —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª —Å–∏—Å—Ç–µ–º–Ω—ã–π ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª.</div>

  <div class="wrap">
    <img id="img" alt="Share Card">
    <div id="msg" class="muted" style="margin-top:10px;font-size:14px"></div>
  </div>

  <div class="bar">
    <button id="share" class="btn">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    <button id="save" class="btn">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å</button>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const imgUrl = params.get('img') || '';
    const imgEl  = document.getElementById('img');
    const msgEl  = document.getElementById('msg');
    const tgHint = document.getElementById('tg-hint');

    // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è Telegram-–≤—å—é–µ—Ä–∞
    const ua = navigator.userAgent.toLowerCase();
    if (ua.includes('telegram')) tgHint.classList.remove('hidden');

    // –ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    if (!imgUrl) {
      msgEl.textContent = '–ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ?img=. –î–æ–±–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ PNG/JPG: ?img=https://...';
    } else {
      imgEl.src = imgUrl;
      msgEl.textContent = '–ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å ‚Äî —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Å—ã–ª–∫–∞ –ø—É–±–ª–∏—á–Ω–∞—è (https) –∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞.';
    }

    const title = '–ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç SmokeFree';
    const text  = '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –∫–∞–∫ —è –¥–≤–∏–≥–∞—é—Å—å –∫ –∂–∏–∑–Ω–∏ –±–µ–∑ —Å–∏–≥–∞—Ä–µ—Ç! üö≠';

    async function shareImageFile() {
      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —à–∞—Ä–∏–Ω–≥–∞ —Ñ–∞–π–ª–æ–≤
        const probe = new File([''], 'probe.png', { type: 'image/png' });
        const canFiles = !!(navigator.canShare && navigator.canShare({ files: [probe] }));

        if (canFiles && imgUrl) {
          // –°–∫–∞—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∫–∞–∫ Blob (Cloudinary –∏ –º–Ω–æ–≥–∏–µ CDN –æ—Ç–¥–∞—é—Ç CORS –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
          const res = await fetch(imgUrl, { mode: 'cors', cache: 'no-store' });
          if (!res.ok) throw new Error('fetch failed');
          const blob = await res.blob();
          const mime = blob.type || 'image/png';
          const ext  = (mime.split('/')[1] || 'png').split('+')[0];
          const file = new File([blob], `smokefree.${ext}`, { type: mime });

          await navigator.share({ files: [file], title, text });
          return;
        }

        // –§–æ–ª–±—ç–∫: –æ–±—ã—á–Ω—ã–π share —Å—Å—ã–ª–∫–∏ (—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—á—Ç–∏ –≤–µ–∑–¥–µ)
        if (navigator.share) {
          await navigator.share({ title, text, url: location.href });
          return;
        }

        // –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Ñ–æ–ª–±—ç–∫
        if (imgUrl) window.open(imgUrl, '_blank');
      } catch (e) {
        if (imgUrl) window.open(imgUrl, '_blank');
      }
    }

    async function downloadImage() {
      if (!imgUrl) return;
      try {
        const res = await fetch(imgUrl, { mode: 'cors', cache: 'no-store' });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'smokefree.png';
        document.body.appendChild(a); a.click();
        a.remove(); URL.revokeObjectURL(url);
      } catch(e) {
        // –ï—Å–ª–∏ CORS –±–ª–æ—á–∏—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
        window.open(imgUrl, '_blank');
      }
    }

    document.getElementById('share').addEventListener('click', shareImageFile);
    document.getElementById('save').addEventListener('click', downloadImage);
  </script>
</body>
</html>
