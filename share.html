<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º ‚Ä¢ SmokeFree</title>
  <style>
    :root { --bg:#0b0c10; --fg:#fff; --glass:rgba(20,20,24,.9); --accent:#38bdf8; }
    body { margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .wrap { max-width:480px; margin:0 auto; padding:16px; text-align:center; }
    .hint { background:#1f2937; border-radius:12px; padding:10px 12px; margin:12px 16px; font-size:14px; line-height:1.35; }
    .hidden{display:none} .muted{opacity:.8}
    img { width:100%; height:auto; border-radius:16px; display:block; background:#111; margin-top:10px; }
    .bar { position:fixed; left:0; right:0; bottom:0; background:var(--glass); backdrop-filter:blur(6px); padding:12px 16px; display:flex; gap:10px; }
    .btn { flex:1; padding:14px 16px; border:0; border-radius:12px; font-size:16px; cursor:pointer; }
    .btn:hover{opacity:.92}
  </style>
</head>
<body>
  <div id="tg-hint" class="hint hidden">
    –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–Ω—É—Ç—Ä–∏ Telegram ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´‚ãØ¬ª ‚Üí <b>–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ</b> (Safari/Chrome), —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∞ –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª.
  </div>

  <div class="wrap">
    <p style="font-weight:700;font-size:20px;margin:6px 0;">üí† –ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–µ–∑ —Å–∏–≥–∞—Ä–µ—Ç!</p>
    <p style="font-weight:600;opacity:.9;margin:0 0 12px;">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è ‚Äî <span style="color:var(--accent);">@SmokeFreeclubBot</span></p>

    <img id="img" alt="Share Card">
    <div id="msg" class="muted" style="margin-top:10px;font-size:14px"></div>
  </div>

  <div class="bar">
    <button id="share" class="btn" style="background:var(--accent);color:#000;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button id="save"  class="btn" style="background:#374151;color:#fff;">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å</button>
  </div>

  <script>
    // --- –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---
    const qs = new URLSearchParams(location.search);
    const rawImg = qs.get('img') || '';
    let imgUrl = rawImg;
    try { imgUrl = decodeURIComponent(rawImg); } catch {}
    const title = 'üí† –ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–µ–∑ —Å–∏–≥–∞—Ä–µ—Ç!';
    const text  = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è ‚Äî @SmokeFreeclubBot';

    const imgEl  = document.getElementById('img');
    const msgEl  = document.getElementById('msg');
    const tgHint = document.getElementById('tg-hint');

    // –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è Telegram webview
    if (navigator.userAgent.toLowerCase().includes('telegram')) {
      tgHint.classList.remove('hidden');
    }

    // –ø–æ–∫–∞–∑–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    (async () => {
      if (!imgUrl) {
        msgEl.textContent = '–ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ?img=. –î–æ–±–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ PNG/JPG: ?img=https://...';
        return;
      }
      imgEl.src = imgUrl;
    })();

    // --- –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∫–∞–∫ –§–ê–ô–õ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è) ---
    async function shareImageFile() {
      try {
        const canFiles = !!(navigator.canShare && navigator.canShare({
          files: [new File([''],'probe.png',{type:'image/png'})]
        }));

        if (canFiles && imgUrl) {
          const res = await fetch(imgUrl, { mode:'cors', cache:'no-store' });
          if (!res.ok) throw new Error('fetch failed');
          const blob = await res.blob();
          const mime = blob.type || 'image/png';
          const ext  = (mime.split('/')[1] || 'png').split('+')[0];
          const file = new File([blob], `smokefree.${ext}`, { type:mime });

          await navigator.share({ files:[file], title, text });
          return;
        }

        // fallback: –æ–±—ã—á–Ω—ã–π share —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ –±–æ—Ç–∞
        if (navigator.share) {
          await navigator.share({ title, text, url:'https://t.me/smokefreeclubbot' });
          return;
        }

        // —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π fallback: –æ—Ç–∫—Ä—ã—Ç—å —Å–∞–º–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        if (imgUrl) window.open(imgUrl, '_blank');
      } catch (e) {
        if (imgUrl) window.open(imgUrl, '_blank');
      }
    }

    // --- –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ ---
    async function downloadImage() {
      if (!imgUrl) return;
      try {
        const res = await fetch(imgUrl, { mode:'cors', cache:'no-store' });
        if (!res.ok) throw new Error('download failed');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'smokefree_result.png';
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 800);
      } catch (e) {
        alert('–ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –µ–≥–æ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª üì•');
      }
    }

    // --- –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ---
    document.getElementById('share').addEventListener('click', shareImageFile);
    document.getElementById('save') .addEventListener('click',  downloadImage);
  </script>
</body>
</html>
