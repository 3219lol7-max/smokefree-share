<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º ‚Ä¢ SmokeFree</title>
  <style>
    :root { --bg:#0b0c10; --fg:#fff; --glass:rgba(20,20,24,.9); --accent:#38bdf8; --ok:#22c55e; --amber:#f59e0b; }
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:480px;margin:0 auto;padding:16px;text-align:center}
    .hint{background:#1f2937;border-radius:12px;padding:10px 12px;margin:12px 16px;font-size:14px;line-height:1.35}
    .hidden{display:none}.muted{opacity:.8}
    img{width:100%;height:auto;border-radius:16px;display:block;background:#111;margin-top:10px}
    .bar{position:fixed;left:0;right:0;bottom:0;background:var(--glass);backdrop-filter:blur(6px);padding:12px 16px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{flex:1;min-width:150px;padding:12px 14px;border:0;border-radius:12px;font-size:15px;cursor:pointer}
    .btn:hover{opacity:.92}
  </style>
</head>
<body>
  <div id="tg-hint" class="hint hidden">
    –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–Ω—É—Ç—Ä–∏ Telegram ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´‚ãØ¬ª ‚Üí <b>–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ</b> (Safari/Chrome), —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∞ –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª.
  </div>

  <div class="wrap">
    <p style="font-weight:700;font-size:20px;margin:6px 0;">üí† –ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–µ–∑ —Å–∏–≥–∞—Ä–µ—Ç!</p>
    <p style="font-weight:600;opacity:.9;margin:0 0 12px;">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è ‚Äî <span style="color:var(--accent);">@SmokeFreeclubBot</span></p>

    <img id="img" alt="Share Card">
    <div id="msg" class="muted" style="margin-top:10px;font-size:14px"></div>
  </div>

  <div class="bar">
    <button id="share"   class="btn" style="background:var(--accent);color:#000;">üì§ –°—Ç–æ—Ä–∏—Å 9:16</button>
    <button id="share45" class="btn" style="background:var(--ok);color:#000;">üì§ –ü–æ—Å—Ç 4:5</button>
    <button id="share11" class="btn" style="background:var(--amber);color:#000;">üì§ –ö–≤–∞–¥—Ä–∞—Ç 1:1</button>
    <button id="save"    class="btn" style="background:#374151;color:#fff;">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å</button>
  </div>

  <script>
    // ===== utils =====
    const log = (...a)=>{ try{ console.log('[SF]',...a);}catch{} };
    window.onerror = (m,s,l,c,e)=>{ try{ console.error('[SF-ERR]',m,s,l,c,e);}catch{} };

    const qs = new URLSearchParams(location.search);
    // –ò–Ω–æ–≥–¥–∞ URL –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –¥–µ–∫–æ–¥–∏—Ä—É–µ–º
    const rawImg = qs.get('img') || '';
    let imgUrl = rawImg;
    try { imgUrl = decodeURIComponent(rawImg); } catch {}
    const title = 'üí† –ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–µ–∑ —Å–∏–≥–∞—Ä–µ—Ç!';
    const text  = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è ‚Äî @SmokeFreeclubBot';

    const imgEl  = document.getElementById('img');
    const msgEl  = document.getElementById('msg');
    const tgHint = document.getElementById('tg-hint');

    const ua = navigator.userAgent.toLowerCase();
    if (ua.includes('telegram')) tgHint.classList.remove('hidden');

    // –ù–∞–¥—ë–∂–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ <img>, –±–µ–∑ createImageBitmap
    function preloadImage(url) {
      return new Promise((resolve, reject) => {
        const im = new Image();
        // CORS –Ω—É–∂–µ–Ω –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å canvas/share —Ñ–∞–π–ª–∞
        im.crossOrigin = 'anonymous';
        im.onload = () => resolve(im);
        im.onerror = (e) => reject(e);
        im.src = url;
      });
    }

    (async () => {
      if (!imgUrl) {
        msgEl.textContent = '–ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ?img=. –î–æ–±–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ PNG/JPG: ?img=https://...';
        return;
      }
      try {
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        imgEl.src = imgUrl;
        // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø—Ä–æ–≥—Ä–µ–µ–º –µ—ë –¥–ª—è –∫–∞–Ω–≤–∞—Å–∞ (–µ—Å–ª–∏ CORS –ø–æ–∑–≤–æ–ª–∏—Ç)
        await preloadImage(imgUrl).catch(()=>{ /* –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ */ });
        msgEl.textContent = '';
      } catch (e) {
        log('preview error', e);
        msgEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É ?img= –∏ HTTPS-–¥–æ—Å—Ç—É–ø.';
      }
    })();

    // ===== —à—ç—Ä —Å—Ç–æ—Ä–∏—Å 9:16 (—Å–∞–º –∏—Å—Ö–æ–¥–Ω–∏–∫) =====
    async function shareImageFile() {
      try {
        const probeOk = !!(navigator.canShare && navigator.canShare({ files: [new File([''],'p.png',{type:'image/png'})] }));
        if (probeOk && imgUrl) {
          const res = await fetch(imgUrl, { mode:'cors', cache:'no-store' });
          if (!res.ok) throw new Error('fetch failed');
          const blob = await res.blob();
          const mime = blob.type || 'image/png';
          const ext  = (mime.split('/')[1] || 'png').split('+')[0];
          const file = new File([blob], `smokefree.${ext}`, { type:mime });
          await navigator.share({ files:[file], title, text });
          return;
        }
        if (navigator.share) { await navigator.share({ title, text, url:'https://t.me/smokefreeclubbot' }); return; }
        if (imgUrl) window.open(imgUrl, '_blank');
      } catch (e) {
        log('share 9:16 error', e);
        if (imgUrl) window.open(imgUrl, '_blank');
      }
    }

    // ===== –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤ 4:5 –∏ 1:1 –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏ =====
    async function renderAndShare(targetW, targetH, filename) {
      if (!imgUrl) return;
      try {
        const res = await fetch(imgUrl, { mode:'cors', cache:'no-store' });
        if (!res.ok) throw new Error('fetch failed');
        const blob = await res.blob();

        // –≥—Ä—É–∑–∏–º —á–µ—Ä–µ–∑ <img>, —Ç–∞–∫ –∫—Ä–æ—Å—Å–±—Ä–∞—É–∑–µ—Ä–Ω–µ–µ
        const srcImg = await preloadImage(URL.createObjectURL(blob));

        const pad = Math.round(targetW * 0.06);
        const c = document.createElement('canvas'); c.width = targetW; c.height = targetH;
        const ctx = c.getContext('2d');

        // —Ñ–æ–Ω cover + –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
        const scaleCover = Math.max(targetW / srcImg.naturalWidth, targetH / srcImg.naturalHeight);
        const bw = Math.round(srcImg.naturalWidth * scaleCover);
        const bh = Math.round(srcImg.naturalHeight * scaleCover);
        const bx = Math.round((targetW - bw) / 2);
        const by = Math.round((targetH - bh) / 2);
        ctx.drawImage(srcImg, bx, by, bw, bh);
        ctx.fillStyle = 'rgba(0,0,0,0.25)';
        ctx.fillRect(0, 0, targetW, targetH);

        // –∫–∞—Ä—Ç–æ—á–∫–∞ —Ü–µ–ª–∏–∫–æ–º ¬´–≤–ø–∏—Å–∞—Ç—å¬ª —Å –ø–æ–ª—è–º–∏
        const availW = targetW - pad*2, availH = targetH - pad*2;
        const scaleFit = Math.min(availW / srcImg.naturalWidth, availH / srcImg.naturalHeight);
        const iw = Math.round(srcImg.naturalWidth * scaleFit);
        const ih = Math.round(srcImg.naturalHeight * scaleFit);
        const ix = Math.round((targetW - iw)/2), iy = Math.round((targetH - ih)/2);
        ctx.shadowColor = 'rgba(0,0,0,0.35)'; ctx.shadowBlur = Math.round(targetW*0.02);
        ctx.drawImage(srcImg, ix, iy, iw, ih); ctx.shadowBlur = 0;

        const outBlob = await new Promise(r => c.toBlob(r, 'image/png', 0.95));
        const file = new File([outBlob], filename, { type:'image/png' });

        if (navigator.canShare && navigator.canShare({ files:[file] })) {
          await navigator.share({ files:[file], title, text });
        } else if (navigator.share) {
          await navigator.share({ title, text, url:'https://t.me/smokefreeclubbot' });
        } else {
          const url = URL.createObjectURL(outBlob);
          const a = document.createElement('a'); a.href = url; a.download = filename;
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }
      } catch (e) {
        log('render/share alt format error', e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ ¬´–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ¬ª –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–°–∫–∞—á–∞—Ç—å¬ª.');
      }
    }

    // ===== –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ =====
    async function downloadImage() {
      if (!imgUrl) return;
      try {
        const res = await fetch(imgUrl, { mode:'cors', cache:'no-store' });
        if (!res.ok) throw new Error('download failed');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'smokefree_result.png'; a.style.display='none';
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 800);
      } catch (e) {
        alert('–ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –µ–≥–æ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª üì•');
      }
    }

    // ===== –∫–Ω–æ–ø–∫–∏ =====
    document.getElementById('share')  .addEventListener('click', shareImageFile);                              // 9:16
    document.getElementById('share45').addEventListener('click', () => renderAndShare(1080,1350,'smokefree_1080x1350.png')); // 4:5
    document.getElementById('share11').addEventListener('click', () => renderAndShare(1080,1080,'smokefree_1080x1080.png')); // 1:1
    document.getElementById('save')   .addEventListener('click', downloadImage);
  </script>
</body>
</html>
